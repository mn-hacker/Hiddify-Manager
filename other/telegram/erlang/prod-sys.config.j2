%% -*- mode: erlang -*-
[
 {mtproto_proxy,
  [
   %% Only allow fake-TLS connections (best anti-detection)
   {allowed_protocols, [mtp_fake_tls]},
   
   %% Ports configuration
   {ports,
    [#{name => mtp_handler_1,
       listen_ip => "0.0.0.0",
       port => 1001,
       secret => <<"{{ hconfigs['shared_secret'].replace("-","") }}">>
       {% if hconfigs['telegram_adtag'] %}
       ,tag => <<"{{ hconfigs['telegram_adtag'] }}">>
       {% endif %}
      }
    ]},
    
   %% Connection limits to prevent abuse
   {init_dc_connections, 4},
   {clients_per_dc_connection, 4000},
   
   %% Replay attack protection
   {replay_check_session_storage, mtp_session_storage_ets}
  ]},

 %% Logging config
 {lager,
  [{log_root, "/var/log/mtproto-proxy"},
   {crash_log, "crash.log"},
   {handlers,
    [
     {lager_console_backend,
      [{level, critical}]},
     {lager_file_backend,
      [{file, "application.log"},
       {level, info},
       {sync_on, critical},
       {high_water_mark, 300},
       {flush_queue, true},
       {flush_threshold, 2000},
       {check_interval, 5000},
       %% Rotate when file size is 50MB
       {size, 52428800}
      ]}
    ]}]},
 {sasl, [{errlog_type, error}]}
].