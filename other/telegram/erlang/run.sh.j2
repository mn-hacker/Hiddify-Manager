#!/bin/bash

MTPROXY_DIR="/opt/hiddify-manager/other/telegram/erlang/mtproto_proxy"
cd "$MTPROXY_DIR" || exit 1

# Copy the config file
cp /opt/hiddify-manager/other/telegram/erlang/prod-sys.config config/prod-sys.config
chmod 600 config/prod-sys.config

# Create/update systemd service
cat > /etc/systemd/system/mtproxy.service << 'EOF'
[Unit]
Description=Erlang MTProto Proxy (seriyps)
Documentation=https://github.com/seriyps/mtproto_proxy
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/hiddify-manager/other/telegram/erlang/mtproto_proxy
ExecStart=/opt/hiddify-manager/other/telegram/erlang/mtproto_proxy/start.sh
ExecStop=/opt/hiddify-manager/other/telegram/erlang/mtproto_proxy/bin/mtp_proxy stop
Restart=always
RestartSec=5
LimitNOFILE=65535
StandardOutput=file:/opt/hiddify-manager/log/system/telegram.out.log
StandardError=file:/opt/hiddify-manager/log/system/telegram.err.log

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable mtproxy.service
systemctl restart mtproxy.service

sleep 2
systemctl status mtproxy --no-pager
