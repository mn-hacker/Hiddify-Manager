{
  "routing": {
    // "domainStrategy": "AsIs",
    "domainStrategy": "IPOnDemand",
    "domainMatcher":"hybrid",
    
      "rules": [
        {
          "type":"field",
          "outboundTag": "freedom",
          "ip": [
            "127.0.0.1",
            {{exec("ip -o -4 addr show | awk '{print $4}' | cut -d/ -f1 | sed 's/.*/\"&\"/' | tr '\n' ',' ")}}
          ],
          "port":"443,80,53"
        },
        
        { //DNS Cache rule
          "type": "field", "port": 53, "network": "tcp,udp", "outboundTag": "DNS-Internal"
        },
        { //block quic
          "type": "field", "port": 443, "network": "udp", "outboundTag": "blackhole"
        },
        {% if hconfigs['block_ads_enable'] %}
        { // Block ads and trackers
          "type": "field",
          "outboundTag": "blackhole",
          "domain": [
            "geosite:category-ads-all"
          ]
        },
        {% endif %}
        {% if hconfigs['block_ads_custom'] %}
        { // Block custom domains
          "type": "field",
          "outboundTag": "blackhole",
          "domain": [
            {% for d in hconfigs['block_ads_custom'].split('\n') %}
            {% if d.strip() %}
            "domain:{{d.strip()}}",
            {% endif %}
            {% endfor %}
          ]
        },
        {% endif %}
        {% if hconfigs['block_malware_enable'] %}
        { // Block malware and phishing
          "type": "field",
          "outboundTag": "blackhole",
          "domain": [
            "geosite:category-phishing",
            "geosite:category-malware"
          ]
        },
        {% endif %}
        {% if hconfigs['block_social_enable'] %}
        { // Block social media
          "type": "field",
          "outboundTag": "blackhole",
          "domain": [
            "geosite:facebook",
            "geosite:instagram",
            "geosite:tiktok",
            "geosite:twitter",
            "geosite:snapchat",
            "geosite:linkedin"
          ]
        },
        {% endif %}
        {% if hconfigs['block_gambling_enable'] %}
        { // Block gambling sites
          "type": "field",
          "outboundTag": "blackhole",
          "domain": [
            "geosite:category-gambling"
          ]
        },
        {% endif %}
        {% if hconfigs['block_adult_enable'] %}
        { // Block adult content
          "type": "field",
          "outboundTag": "blackhole",
          "domain": [
            "geosite:category-porn"
          ]
        },
        {% endif %}
        {% if hconfigs['warp_mode'] != 'all' %}
        {
            "type": "field", 
            "outboundTag": {% if hconfigs['warp_mode'] == 'disable' %}"forbidden_sites"{% else %}"WARP"{% endif %},
            {% if hconfigs['country'] in ['zh','cn'] %}
              "ip": ["geoip:cn"]
            {% elif hconfigs['country'] == 'ir' %}
              "ip": ["geoip:ir"]
            {% elif hconfigs['country'] == 'ru' %}
              "ip": ["geoip:ru"]
            {% else %}
              "ip": ["geoip:cn"]
            {% endif %}
        },
        {
            "type": "field", 
            "outboundTag": {% if hconfigs['warp_mode'] == 'disable' %}"forbidden_sites"{% else %}"WARP"{% endif %},
            {% if hconfigs['country'] in ['zh','cn'] %}
              "domain": ["geosite:cn","tld-cn"] 
            {% elif hconfigs['country'] == 'ir' %}
              "domain": ["tld-ir"]
            {% elif hconfigs['country'] == 'ru' %}
              "domain": ["tld-ru"]
            {% else %}
              "domain": ["geosite:cn","tld-cn"] 
            {% endif %}
        },
         {
                "type":"field",
                "outboundTag": {% if hconfigs['warp_mode'] == 'disable' %}"freedom"{% else %}"WARP"{% endif %},
                "domain":[
                    "geosite:google",
                    "geosite:netflix",
                    "geosite:spotify",
                    "geosite:nvidia",
                    "geosite:bytedance",
                    "geosite:tiktok",
                    "geosite:unity",
                    "geosite:reddit",
                    "geosite:openai",

                    "domain:ip.gs",
                    "domain:kmplayer.com",
                    "domain:ipinfo.io",
                    "domain:openai.com",
                    "domain:ai.com",
                    "domain:freepik.com",
                    "domain:developer.mozilla.org",
                    "domain:behance.net",
                    "domain:remini.com",
                    "domain:snapchat.com",
                    "domain:tunetank.com",
                    "domain:livechart.me",
                    "domain:9anime.me",
                    "domain:pixelexperience.org",
                    "domain:evolution-x.org",
                    "domain:kenvyra.xyz",
                    "domain:spark-os.live",
                    "domain:pixelos.net",
                    "domain:gamebanana.com",
                    "domain:myanimelist.net",
                    "domain:sourcemod.net",
                    "domain:alliedmods.net",
                    "domain:pagespeed.web.dev",
                    "domain:axieinfinity.com",
                    "domain:clubhouse.com",
                    "domain:omegle.com",
                    "domain:alldatasheet.com",
                    "domain:flaticon.com",
                    "domain:xda-developers.com",
                    "domain:giglio.com",
                    "domain:lookmovie2.to",
                    "domain:adbtc.top",
                    "domain:homedepot.com",
                    "domain:flutter.dev",
                    "domain:adobe.com"
                    {% if hconfigs['warp_mode'] != 'disable' %}
                      {%for d in hconfigs.get('warp_sites','').split('\n')%}
                      ,"domain:{{d.strip()}}"
                      {% endfor %}
                    {% endif %}
                ]
            },
        {% endif %}
        {
          "inboundTag": ["api"], "outboundTag": "api", "type": "field"
        },
        {
          "type": "field", "outboundTag": "blackhole", "ip": ["geoip:private"]
        },
        {// Block BitTorrent protocol
          "type": "field", "outboundTag": "blackhole", "protocol": ["bittorrent"]
        },
        {
          "type": "field",
          "port": "0-65535",
          "outboundTag": {% if hconfigs['warp_mode'] == 'all' %}"WARP"{% else %}"freedom"{% endif %}
        }
      ]
    
  }

}
